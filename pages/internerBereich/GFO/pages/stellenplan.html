<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clinicon - Stellenplan</title>
  <style id="app-shell-style">
@import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap");

:root{
  --bg:#f6f2ea;
  --bg-ink:#0d1433;
  --bg-grad:radial-gradient(1200px 680px at 90% -10%, rgba(255,110,64,0.18), transparent 60%),
    radial-gradient(1000px 520px at -10% 0%, rgba(24,196,190,0.18), transparent 58%),
    linear-gradient(180deg, #fff7ee 0%, #f4f6fb 100%);
  --surface:#ffffff;
  --surface-2:#f1f5fb;
  --surface-3:#fdf6ef;
  --ink:#0d1433;
  --muted:#5f6f88;
  --line:rgba(13,20,51,0.1);
  --accent:#1c6bff;
  --accent-2:#ff6b35;
  --accent-3:#17c3b2;
  --accent-4:#f6bd60;
  --accent-5:#f46036;
  --success:#2fbf71;
  --warning:#ff9f1c;
  --danger:#ef476f;
  --shadow:0 20px 46px rgba(12, 20, 45, 0.12);
  --shadow-soft:0 12px 26px rgba(18, 28, 58, 0.08);
  --radius-lg:20px;
  --radius-md:16px;
  --radius-sm:12px;
  --font-base:"Manrope","Segoe UI",sans-serif;
  --font-display:"Space Grotesk","Manrope",sans-serif;

  --panel:var(--surface);
  --text:var(--ink);
  --accent-strong:#1450d6;
  --accent-weak:rgba(28,107,255,0.12);
  --font-size-base:16px;
  --line-height-base:1.6;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--font-base);
  font-size:var(--font-size-base);
  line-height:var(--line-height-base);
  background:var(--bg);
  color:var(--ink);
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:var(--bg-grad);
  z-index:-2;
}
body::after{
  content:"";
  position:fixed;
  inset:0;
  background:
    radial-gradient(380px 380px at 8% 90%, rgba(28,107,255,0.08), transparent 60%),
    radial-gradient(280px 280px at 92% 92%, rgba(246,189,96,0.12), transparent 55%);
  z-index:-1;
}

.app-shell{
  display:grid;
  grid-template-columns:260px 1fr;
  min-height:100dvh;
}
.app-side{
  position:sticky;
  top:0;
  height:100dvh;
  padding:20px 16px;
  display:flex;
  flex-direction:column;
  gap:18px;
  border-right:1px solid var(--line);
  background:rgba(255,255,255,0.86);
  backdrop-filter:blur(12px);
}
.app-brand{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px 14px;
  border-radius:var(--radius-md);
  background:linear-gradient(135deg, rgba(28,107,255,0.12), rgba(23,195,178,0.12));
  border:1px solid rgba(28,107,255,0.16);
  text-decoration:none;
  color:var(--ink);
}
.app-brand-logo{
  width:46px;
  height:46px;
  object-fit:contain;
}
.app-brand-text{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.app-brand-title{
  font-family:var(--font-display);
  font-size:1.05rem;
  letter-spacing:.01em;
}
.app-brand-sub{
  font-size:.7rem;
  letter-spacing:.22em;
  text-transform:uppercase;
  color:var(--muted);
}
.app-nav{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.app-nav a{
  display:flex;
  align-items:center;
  gap:12px;
  text-decoration:none;
  color:var(--ink);
  padding:12px 14px;
  border-radius:var(--radius-sm);
  border:1px solid transparent;
  background:linear-gradient(180deg, #ffffff, #f7f9ff);
  box-shadow:0 1px 0 rgba(14,20,43,0.05);
  transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}
.app-nav a:hover{
  transform:translateY(-1px);
  border-color:rgba(28,107,255,0.25);
  box-shadow:0 10px 20px rgba(28,107,255,0.15);
}
.app-nav a.active{
  background:linear-gradient(135deg, var(--accent), #458cff);
  color:#fff;
  border-color:transparent;
  box-shadow:0 14px 26px rgba(28,107,255,0.3);
}
.app-nav a span{
  font-weight:500;
  letter-spacing:.01em;
}
.app-nav a svg{width:22px; height:22px}
.app-side-footer{
  margin-top:auto;
  font-size:12px;
  color:var(--muted);
}

.app-body{
  display:flex;
  flex-direction:column;
  min-height:100dvh;
}
.app-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:18px;
  padding:22px 28px;
  background:rgba(255,255,255,0.9);
  border-bottom:1px solid var(--line);
  position:sticky;
  top:0;
  z-index:3;
  backdrop-filter:blur(8px);
}
.app-header-left h1{
  margin:0;
  font-size:1.8rem;
  font-family:var(--font-display);
  letter-spacing:.01em;
}
.app-header-left p{
  margin:6px 0 0;
  color:var(--muted);
  font-size:.98rem;
}
.app-header-right{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.app-actions{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.app-pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  font-size:.86rem;
  background:var(--surface-3);
  border:1px solid rgba(246,189,96,0.35);
  color:#9a5b1f;
  font-weight:600;
}
.app-pill.app-pill-neutral{
  background:var(--surface-2);
  border-color:var(--line);
  color:var(--ink);
}
.app-button{
  border:none;
  padding:10px 14px;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
  font-family:var(--font-base);
}
.app-button.primary{
  background:linear-gradient(135deg, var(--accent-2), var(--accent-5));
  color:#fff;
  box-shadow:0 12px 24px rgba(255,107,53,0.35);
}
.app-button.secondary{
  background:#fff;
  border:1px solid var(--line);
  color:var(--ink);
}

.app-timeslicer{
  padding:18px 28px 0;
}
.timeslicer-card{
  border:1px solid var(--line);
  border-radius:var(--radius-md);
  background:rgba(255,255,255,0.9);
  backdrop-filter:blur(8px);
  box-shadow:var(--shadow-soft);
  padding:16px 18px;
  display:flex;
  flex-direction:column;
  gap:14px;
}
.timeslicer-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}
.timeslicer-title{
  font-family:var(--font-display);
  font-size:1.1rem;
}
.timeslicer-sub{
  color:var(--muted);
  font-size:.9rem;
}
.timeslicer-pill{
  padding:6px 12px;
  border-radius:999px;
  background:var(--surface-2);
  border:1px solid var(--line);
  font-weight:700;
  font-size:.82rem;
}
.timeslicer-controls{
  display:flex;
  align-items:center;
  flex-wrap:wrap;
  gap:12px;
}
.timeslicer-buttons{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.timeslicer-btn{
  border:1px solid var(--line);
  background:#fff;
  color:var(--ink);
  padding:8px 12px;
  border-radius:999px;
  font-weight:600;
  cursor:pointer;
  transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}
.timeslicer-btn:hover{
  border-color:rgba(28,107,255,0.25);
  box-shadow:0 8px 16px rgba(28,107,255,0.15);
}
.timeslicer-btn.active{
  background:linear-gradient(135deg, var(--accent), #458cff);
  color:#fff;
  border-color:transparent;
  box-shadow:0 12px 24px rgba(28,107,255,0.25);
}
.timeslicer-custom{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
  color:var(--muted);
  font-size:.9rem;
}
.timeslicer-custom input{
  padding:7px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  font:inherit;
  background:#fff;
  color:var(--ink);
}

.app-main{
  flex:1;
  width:100%;
}
.app-main .card{
  background:var(--surface);
  border-radius:var(--radius-md);
  border:1px solid var(--line);
  box-shadow:var(--shadow-soft);
}

/* Legacy shell layout (GFO pages) */
.shell{
  display:grid;
  grid-template-columns:240px 1fr;
  min-height:100dvh;
}
.side{
  position:sticky;
  top:0;
  height:100dvh;
  padding:20px 16px;
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  gap:18px;
  border-right:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(235,244,255,0.92));
  backdrop-filter:blur(12px);
  box-shadow:0 12px 28px rgba(15,23,42,0.06);
}
.brand{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:8px 10px;
  width:100%;
  border-radius:14px;
  background:transparent;
  border:none;
  box-shadow:none;
  text-decoration:none;
}
.brand img{
  width:200px;
  max-width:100%;
  height:auto;
  object-fit:contain;
  filter:drop-shadow(0 10px 20px rgba(15,23,42,0.12)) saturate(0.9) brightness(1.05);
  opacity:0.95;
}
.side-footer{
  margin-top:auto;
  font-size:12px;
  color:var(--muted);
}
.nav{
  display:flex;
  flex-direction:column;
  gap:10px;
  width:100%;
  margin-top:8px;
}
.nav a{
  display:flex;
  align-items:center;
  gap:12px;
  text-decoration:none;
  color:var(--ink, var(--text));
  width:100%;
  padding:12px 16px;
  border-radius:18px;
  border:1px solid rgba(15,23,42,0.08);
  background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(246,249,255,0.96));
  box-shadow:0 10px 20px rgba(15,23,42,0.06);
  transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}
.nav a:hover{
  transform:translateY(-1px);
  border-color:rgba(28,107,255,0.28);
  box-shadow:0 16px 30px rgba(28,107,255,0.18);
}
.nav a.active{
  background:linear-gradient(135deg, var(--accent), #458cff);
  color:#fff;
  border-color:transparent;
  box-shadow:0 18px 34px rgba(28,107,255,0.28);
}
.nav a span{
  font-weight:500;
  letter-spacing:.01em;
}
.nav a svg{
  width:28px;
  height:28px;
  padding:6px;
  border-radius:12px;
  background:rgba(28,107,255,0.12);
  color:#1f4b82;
  flex-shrink:0;
  box-shadow:inset 0 0 0 1px rgba(28,107,255,0.12);
}
.nav a.active svg{
  background:rgba(255,255,255,0.25);
  color:#fff;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,0.35);
}
.nav-group{
  width:100%;
  display:flex;
  flex-direction:column;
  gap:8px;
  padding:4px 0 0;
}
.nav-group-title{
  padding-left:8px;
  font-size:0.72rem;
  text-transform:uppercase;
  letter-spacing:.16em;
  color:var(--muted);
}
.nav-sub{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin:0;
  padding-left:0;
}
.nav-sub a{
  border-radius:16px;
  padding:10px 14px;
}
.nav-sub a svg{
  width:24px;
  height:24px;
  padding:5px;
  border-radius:10px;
}
header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:16px;
  padding:20px 24px;
  border-bottom:1px solid var(--line);
  background:rgba(255,255,255,0.9);
  position:sticky;
  top:0;
  z-index:2;
  backdrop-filter:blur(8px);
}
.topbar-left h1{
  margin:0;
  font-size:1.9rem;
  font-family:var(--font-display);
  letter-spacing:.01em;
}
.topbar-left p{
  margin:6px 0 0;
  color:var(--muted);
  font-size:1rem;
}
.topbar-actions{
  display:flex;
  align-items:center;
  gap:10px;
}
.timestamp-pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  font-size:.86rem;
  background:var(--surface-2);
  border:1px solid var(--line);
  color:var(--muted);
  font-weight:600;
}
@media (max-width: 960px){
  .shell{grid-template-columns:1fr;}
  .side{
    position:relative;
    height:auto;
  }
  header{position:relative;}
}

@media (max-width: 1200px){
  .app-shell{grid-template-columns:1fr;}
  .app-side{
    position:relative;
    height:auto;
    flex-direction:row;
    flex-wrap:wrap;
    justify-content:space-between;
  }
  .app-nav{flex-direction:row; flex-wrap:wrap;}
}
@media (max-width: 900px){
  .app-header{flex-direction:column; align-items:flex-start;}
  .app-timeslicer{padding:16px 20px 0;}
}
@media (max-width: 600px){
  .app-header{padding:18px 20px;}
  .timeslicer-card{padding:14px;}
}

.name-pair{display:flex; gap:8px;}
.name-pair input{flex:1; min-width:0;}
.action-icons{display:flex; align-items:center; justify-content:center; gap:8px;}
.action-copy{width:34px; height:34px; border-radius:8px; border:1px solid var(--line); background:linear-gradient(135deg, var(--accent-3), var(--accent-5)); color:#fff; font-weight:700; font-size:0.95rem;}
.action-copy:hover{box-shadow:0 8px 16px rgba(28,107,255,0.15);}
.row-hint{font-size:0.74rem; color:var(--muted);}
.month-input{
  width:58px;
  padding:6px 4px;
  border-radius:6px;
  font-size:0.85rem;
  text-align:center;
}
.qual-select{
  min-width:180px;
  border-radius:8px;
  border:1px solid var(--line);
  background:#fff;
  padding:6px 8px;
  font:inherit;
}
.action-icons{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:6px;
}
.action-icons button{
  width:34px;
  height:34px;
  border-radius:8px;
  border:none;
  font-size:1rem;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}
.action-icons button.action-hide{background:#eef2ff; color:#0f63ff;}
.action-icons button.action-trash{background:#fee2e2; color:#dc2626;}
.action-icons button.action-copy{background:linear-gradient(135deg, #0ea5e9, #14b8a6); color:#fff;}
.action-icons button:hover{opacity:0.85;}

  </style>
  <style id="page-style">
:root{
      --header:var(--surface-2);
      --row:#f7f9ff;
      --hover:rgba(28,107,255,0.08);
    }
main{padding:20px; display:flex; flex-direction:column; gap:16px; width:100%; max-width:100%; margin:0 auto;}
    .card{box-shadow:var(--shadow-soft); border:1px solid var(--line); background:var(--surface);}
    .top{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:18px;
      background:linear-gradient(120deg, rgba(28,107,255,0.14), rgba(23,195,178,0.18));
      border:1px solid rgba(28,107,255,0.18);
    }
    .header-row{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap; padding-bottom:8px; border-bottom:1px solid var(--line);}
    .hero-title{display:flex; flex-direction:column; gap:6px;}
    .pill{
      display:inline-flex;
      gap:8px;
      padding:7px 12px;
      border-radius:12px;
      background:linear-gradient(135deg, var(--accent), #458cff);
      color:#fff;
      font-weight:700;
      box-shadow:0 12px 24px rgba(28,107,255,0.25);
    }
    h1{margin:0;}
    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; margin-top:6px; padding-top:6px;}
    .controls label{display:flex; flex-direction:column; gap:4px; font-weight:700; color:#0f172a;}
    .controls select,.controls input{padding:9px 11px; border:1px solid var(--line); border-radius:12px; font:inherit; background:#fff; box-shadow:0 7px 18px rgba(15,23,42,0.05);}
    .controls button{
      border:1px solid transparent;
      background:linear-gradient(135deg, var(--accent-3), #6ee7d4);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      color:#0f172a;
      transition:.15s ease all;
      box-shadow:0 9px 20px rgba(18,53,92,.16);
      margin-top:6px;
    }
    .controls button.primary{background:linear-gradient(135deg, var(--accent), #458cff); color:#fff;}
    .controls .btn-save{background:linear-gradient(135deg, #fb8c00, #ff6f00); color:#fff; box-shadow:0 9px 20px rgba(255,140,0,.35);}
    .controls button:hover{box-shadow:0 12px 28px rgba(18,53,92,.2); transform:translateY(-1px);} .controls button:active{transform:translateY(0);}
    .summary{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px;}
    .tile{
      padding:14px 16px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow-soft);
      display:grid;
      gap:6px;
      position:relative;
      overflow:hidden;
    }
    .tile::after{
      content:"";
      position:absolute;
      inset:auto -35% -55% auto;
      width:140px;
      height:140px;
      border-radius:50%;
      opacity:.12;
      background:var(--accent);
    }
    .tile span{color:var(--muted);} .tile strong{font-size:1.3rem;}
    .table-wrap{overflow:auto; border:1px solid var(--line); border-radius:12px; background:var(--surface); box-shadow:var(--shadow-soft); scrollbar-width:none;} .table-wrap::-webkit-scrollbar{display:none;} table{width:100%; border-collapse:collapse; font-size:0.94rem;} th,td{padding:10px 8px; border-bottom:1px solid var(--line); text-align:left; vertical-align:middle;} th{background:var(--header); color:var(--ink); position:sticky; top:0; z-index:2; font-size:0.9rem; border-right:1px solid rgba(13,20,51,0.08); font-weight:800;} th:last-child{border-right:none;} th:first-child, td:first-child{position:sticky; left:0; background:var(--surface); z-index:3; border-right:1px solid rgba(13,20,51,0.08);} tr:nth-child(even) td{background:#f9fbff;} tr:hover td{background:var(--hover);} .sort-indicator{font-size:0.8rem; color:var(--muted); margin-left:6px;}
    .name-input,.vk-input{width:100%; padding:8px 8px; border:1px solid var(--line); border-radius:8px; font:inherit; text-align:center; background:#fff; transition:.15s ease all;} .name-input{text-align:left;} .name-input:focus,.vk-input:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(28,107,255,.2);} .vk-input::-webkit-outer-spin-button,.vk-input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;} .vk-input{-moz-appearance:textfield;} td.actions-cell, th.actions-col{vertical-align:middle; text-align:center; padding:6px 8px; min-width:140px;} .actions-cell .action-buttons{display:flex; gap:8px; justify-content:center; align-items:center;} .icon-btn{width:38px; height:38px; border-radius:8px; border:1px solid var(--line); background:#fff; cursor:pointer; box-shadow:0 4px 10px rgba(15,23,42,0.08); display:flex; align-items:center; justify-content:center;} .icon-btn:hover{background:#f1f5f9;} th.actions-col, td.actions-cell{text-align:center;} .totals-row td{font-weight:700; background:var(--surface-2);} .spacer-row td{background:#f1f5f9;} .hint{color:var(--muted); margin:4px 0 0;} .pnr-cell input{background:#eef2ff; border-color:#c7d2fe;}
    .row-muted td{background:linear-gradient(90deg,#e2e8f0,#f8fafc); color:#334155; box-shadow:inset 4px 0 0 #cbd5e1;}
    .row-muted td:first-child{background:linear-gradient(90deg,#cbd5e1,#e2e8f0); box-shadow:inset 6px 0 0 #94a3b8; position:sticky; left:0;}
    .row-muted td:first-child::before{content:'Ausgeblendet'; position:absolute; top:6px; right:8px; background:#94a3b8; color:#0f172a; padding:2px 8px; border-radius:10px; font-size:0.75rem; font-weight:700;}
    .row-muted input,.row-muted .qual-badge{background:#e2e8f0; border-color:#cbd5e1; color:#334155;}
    .row-muted .qual-badge span:last-child{color:#1f2937;}
    .row-muted td:first-child input{padding-top:18px;}
    .action-menu{position:absolute; background:#fff; border:1px solid var(--line); box-shadow:0 12px 30px rgba(15,23,42,0.18); border-radius:10px; padding:6px 0; display:none; z-index:120;} .action-menu button{display:block; width:100%; padding:8px 14px; background:none; border:none; text-align:left; cursor:pointer; font:inherit;} .action-menu button:hover{background:#f1f5f9;}
    th.month-col, td.month-col{min-width:68px; width:68px;}
    .save-status{display:inline-block; padding:6px 10px; border-radius:10px; background:rgba(23,195,178,0.16); color:#0f172a; border:1px solid rgba(23,195,178,0.4); font-weight:600;} .save-status.error{background:#fef2f2; border-color:#fecdd3; color:#991b1b;}
    .qual-badge{width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#f8fafc; cursor:pointer; text-align:left; font-size:0.88rem; display:flex; justify-content:space-between; align-items:center;}
    .qual-popover{position:absolute; background:#fff; border:1px solid var(--line); box-shadow:0 12px 30px rgba(15,23,42,0.16); border-radius:12px; padding:10px; display:none; z-index:99; width:240px; max-height:260px; overflow:auto;}
    .qual-popover label{display:flex; align-items:center; gap:8px; font-size:0.88rem; padding:4px 2px;}
    @media (max-width: 900px){

th:nth-child(2), td:nth-child(2){left:100px;} th:first-child, td:first-child{min-width:100px;}}
@media (max-width: 900px){

}
    @media (max-width: 600px){
}
    @media (max-width: 900px){
    }
  </style>
</head>
<body>
  <template id="page-content">
<section class="card top">
      <div class="header-row">
        <div class="hero-title">
<h1>Planung &amp; Kontrolle</h1>
          <p style="margin:0; color:var(--muted);">Mitarbeiter:innen und Zusatzgruppen pflegen, VK-Werte pro Monat sichern.</p>
        </div>
        <span id="saveStatus" class="save-status" aria-live="polite" style="display:none;"></span>
      </div>
      <div class="controls">
        <label style="display:flex; flex-direction:column; gap:4px; min-width:200px;">Abteilung
          <select id="deptSelect"></select>
        </label>
        <label style="display:flex; flex-direction:column; gap:4px; min-width:120px;">Jahr
          <input id="yearInput" type="number" min="2020" max="2100" />
        </label>
        <button id="btnAddRow" class="primary" type="button">+ Mitarbeiter:in</button>
        <button id="btnAddExtra" type="button">+ Zusatzzeile</button>
        <button id="btnSaveDb" class="btn-save" type="button">Speichern (DB)</button>
      </div>
      <div class="summary">
        <div class="tile"><span>Summe (Jahr)</span><strong id="sumYear">0,0</strong></div>
        <div class="tile"><span>Durchschnitt / Monat</span><strong id="avgMonth">0,0</strong></div>
        <div class="tile"><span>Peak-Monat</span><strong id="peakMonth">-</strong></div>
      </div>
    </section>

    <section class="card">
      <div class="table-wrap">
        <table id="planTable">
          <thead>
            <tr>
              <th style="min-width:120px;" data-sort="pnr">Personalnummer <span class="sort-indicator" data-sort-ind="pnr"></span></th>
              <th style="min-width:200px;" data-sort="name">Vorname &amp; Nachname <span class="sort-indicator" data-sort-ind="name"></span></th>
              <th class="month-col">Jan</th><th class="month-col">Feb</th><th class="month-col">Mrz</th><th class="month-col">Apr</th><th class="month-col">Mai</th><th class="month-col">Jun</th>
              <th class="month-col">Jul</th><th class="month-col">Aug</th><th class="month-col">Sep</th><th class="month-col">Okt</th><th class="month-col">Nov</th><th class="month-col">Dez</th>
              <th>&Oslash; Monat</th>
              <th style="min-width:140px;">Qualifikation</th>
              <th class="actions-col">Aktionen</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr class="totals-row">
              <td></td>
              <td>Summe Monat</td>
              <td data-sum-month="0">0,0</td><td data-sum-month="1">0,0</td><td data-sum-month="2">0,0</td><td data-sum-month="3">0,0</td><td data-sum-month="4">0,0</td><td data-sum-month="5">0,0</td><td data-sum-month="6">0,0</td><td data-sum-month="7">0,0</td><td data-sum-month="8">0,0</td><td data-sum-month="9">0,0</td><td data-sum-month="10">0,0</td><td data-sum-month="11">0,0</td>
              <td data-total-year>0,0</td>
              <td></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <section class="card">
      <div class="section-header">
        <h3 style="margin-top:0;">Zusatzgruppen (SchÃ¼ler:innen, Azubis, MFA, ATA ...)</h3>
      </div>
      <div class="table-wrap">
        <table id="extrasTable">
          <thead>
            <tr>
              <th style="min-width:120px;" data-sort="pnr-ex">Personalnummer <span class="sort-indicator" data-sort-ind="pnr-ex"></span></th>
              <th style="min-width:200px;" data-sort="cat-ex">Kategorie <span class="sort-indicator" data-sort-ind="cat-ex"></span></th>
              <th class="month-col">Jan</th><th class="month-col">Feb</th><th class="month-col">Mrz</th><th class="month-col">Apr</th><th class="month-col">Mai</th><th class="month-col">Jun</th>
              <th class="month-col">Jul</th><th class="month-col">Aug</th><th class="month-col">Sep</th><th class="month-col">Okt</th><th class="month-col">Nov</th><th class="month-col">Dez</th>
              <th>&Oslash; Monat</th>
              <th style="min-width:140px;">Qualifikation</th>
              <th class="actions-col">Aktionen</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr class="totals-row">
              <td></td>
              <td>Summe Zusatz</td>
              <td data-extra-month="0">0,0</td><td data-extra-month="1">0,0</td><td data-extra-month="2">0,0</td><td data-extra-month="3">0,0</td><td data-extra-month="4">0,0</td><td data-extra-month="5">0,0</td><td data-extra-month="6">0,0</td><td data-extra-month="7">0,0</td><td data-extra-month="8">0,0</td><td data-extra-month="9">0,0</td><td data-extra-month="10">0,0</td><td data-extra-month="11">0,0</td>
              <td data-total-extra>0,0</td>
              <td></td>
              <td></td>
            </tr>
            <tr class="totals-row spacer-row">
              <td></td>
              <td>Abschluss (Haupt + Zusatz)</td>
              <td data-combined-month="0">0,0</td><td data-combined-month="1">0,0</td><td data-combined-month="2">0,0</td><td data-combined-month="3">0,0</td><td data-combined-month="4">0,0</td><td data-combined-month="5">0,0</td><td data-combined-month="6">0,0</td><td data-combined-month="7">0,0</td><td data-combined-month="8">0,0</td><td data-combined-month="9">0,0</td><td data-combined-month="10">0,0</td><td data-combined-month="11">0,0</td>
              <td data-total-combined>0,0</td>
              <td></td>
              <td></td>
            </tr>
            <tr class="totals-row">
              <td></td>
              <td>Wirtschaftsplan (VK)</td>
              <td colspan="12" id="planRowNote" style="text-align:right; font-size:0.9rem; color:#475569;">-</td>
              <td data-plan-total>0,0</td>
              <td data-plan-delta>0,0</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>


  <script type="module" defer>
/* Clinicon Stellenplan - Frontend (D1 via /api/*)
   Erwartete Elemente:
   - select#deptSelect, input#yearInput
   - button#btnSaveDb, button#btnAddRow, button#btnAddExtra
   - table#planTable, table#extrasTable
   - div/span#saveStatus, #sumYear, #avgMonth, #peakMonth
*/

(() => {
  const $ = (sel) => document.querySelector(sel);
  const fmt = (n) => (Number(n || 0)).toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const clamp2 = (v) => {
    const normalized = Math.max(0, Math.min(1, Number(v || 0)));
    return Math.round((normalized + Number.EPSILON) * 100) / 100;
  };

  const API = {
    async getOrgUnits() {
      const r = await fetch("/api/org-units", { credentials: "same-origin" });
      if (!r.ok) throw new Error("Organisationseinheiten laden fehlgeschlagen");
      return r.json();
    },
    async getQualifikationen() {
      const r = await fetch("/api/qualifikationen", { credentials: "same-origin" });
      if (!r.ok) throw new Error("Qualifikationen laden fehlgeschlagen");
      return r.json();
    },
    async loadPlan(orgCode, year) {
      const r = await fetch(`/api/stellenplan?org=${encodeURIComponent(orgCode)}&year=${encodeURIComponent(year)}`, { credentials: "same-origin" });
      if (!r.ok) throw new Error("Stellenplan laden fehlgeschlagen");
      return r.json();
    },
    async savePlan(payload) {
      const r = await fetch("/api/stellenplan/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify(payload),
      });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    },
  };

  const els = {
    deptSelect: $("#deptSelect"),
    yearInput: $("#yearInput"),
    planTable: $("#planTable"),
    extrasTable: $("#extrasTable"),
    btnSaveDb: $("#btnSaveDb"),
    btnAddRow: $("#btnAddRow"),
    btnAddExtra: $("#btnAddExtra"),
    saveStatus: $("#saveStatus"),
    sumYear: $("#sumYear"),
    avgMonth: $("#avgMonth"),
    peakMonth: $("#peakMonth"),
  };

  const STORAGE_KEY = "clinicon_stellenplan_v1";
  const FALLBACK_ORG_UNITS = [
    { code: "STA1", name: "Station 1" },
    { code: "STA2", name: "Station 2" },
    { code: "STA3", name: "Station 3" },
    { code: "STA4", name: "Station 4" },
    { code: "STA5", name: "Station 5" },
    { code: "OPS", name: "OP / Endoskopie" },
    { code: "PDL", name: "Pflegedienstleitung" },
  ];
  const FALLBACK_QUAL_OPTIONS = [
    "Pflegefachkraft",
    "Pflegefachassistenz",
    "Notfallpflege",
    "Intensivpflege",
    "Hygiene",
    "Praxisanleitung",
    "OP",
    "Endoskopie",
    "Onkologie",
    "Palliativ",
    "Wundmanagement",
    "Dialyse",
  ];
  const state = {
    orgUnits: [],
    qualOptions: [],
    dept: "",
    year: new Date().getFullYear(),
    data: {},
  };
  let lastFocus = null;

  function setStatus(msg, isError = false) {
    if (!els.saveStatus) return;
    els.saveStatus.textContent = msg || "";
    els.saveStatus.style.opacity = msg ? "1" : "0";
    els.saveStatus.style.color = isError ? "#b91c1c" : "";
  }

  function loadStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === "object") {
        state.data = parsed.data || {};
        state.dept = parsed.dept || state.dept;
        state.year = parsed.year || state.year;
      }
    } catch (_) {}
  }

  function saveStorage() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ dept: state.dept, year: state.year, data: state.data }));
    } catch (_) {}
  }

  function key() {
    return `${state.dept}-${state.year}`;
  }

  function ensurePlan() {
    const k = key();
    if (!state.data[k]) {
      state.data[k] = { employees: [], extras: [] };
    }
    for (const r of state.data[k].employees) {
      if (!Array.isArray(r.values) || r.values.length !== 12) r.values = Array(12).fill(0);
      if (typeof r.include !== "boolean") r.include = true;
      if (typeof r.hiddenRow !== "boolean") r.hiddenRow = false;
      r.qual = r.qual || "";
      r.personalNumber = (r.personalNumber ?? "").toString();
      r.name = (r.name ?? "").toString();
      ensureNameParts(r);
      r.values = r.values.map(v => clamp2(v));
    }
    for (const x of state.data[k].extras) {
      if (!Array.isArray(x.values) || x.values.length !== 12) x.values = Array(12).fill(0);
      if (typeof x.include !== "boolean") x.include = true;
      if (typeof x.hiddenRow !== "boolean") x.hiddenRow = false;
      x.qual = x.qual || "";
      x.personalNumber = (x.personalNumber ?? "").toString();
      x.category = (x.category ?? "Zusatz").toString();
      x.values = x.values.map(v => clamp2(v));
    }
    return state.data[k];
  }

  function ensureNameParts(row) {
    const raw = (row.name || "").trim();
    const parts = raw ? raw.split(/\s+/) : [];
    row.firstName = (row.firstName ?? parts.shift() ?? "").trim();
    row.lastName = (row.lastName ?? parts.join(" ") ?? "").trim();
    row.name = `${row.firstName} ${row.lastName}`.trim();
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>\"']/g, (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[c]));
  }

  function syncName(row) {
    row.name = `${row.firstName || ""} ${row.lastName || ""}`.trim();
  }

  function qualSelectHTML(value, idx, kind) {
    const vals = (String(value || "").split(",").map(v => v.trim()).filter(Boolean));
    const opts = state.qualOptions.map(q => {
      const escaped = escapeHtml(q);
      const selected = vals.includes(q) ? " selected" : "";
      return `<option value="${escaped}"${selected}>${escaped}</option>`;
    });
    return `<select multiple size="3" class="sp-qual qual-select" data-kind="${kind}" data-idx="${idx}">${opts.join("")}</select>`;
  }

  function renderPlanTable() {
    const plan = ensurePlan();
    const table = els.planTable;
    if (!table) return;
    const tbody = table.querySelector("tbody") || table.appendChild(document.createElement("tbody"));
    tbody.innerHTML = "";

    plan.employees.forEach((r, idx) => {
      const tr = document.createElement("tr");
      tr.dataset.kind = "emp";
      tr.dataset.idx = String(idx);
      if (r.hiddenRow) tr.style.display = "none";
      const tds = [];
      tds.push(`
        <td class="pnr-col">
          <input class="sp-pnr" data-kind="emp" data-idx="${idx}" value="${escapeHtml(r.personalNumber)}" placeholder="Personalnr.">
        </td>
      `);
      tds.push(`
        <td class="name-col">
          <div class="name-pair">
            <input class="name-input sp-name-first" data-kind="emp" data-idx="${idx}" value="${escapeHtml(r.firstName)}" placeholder="Vorname">
            <input class="name-input sp-name-last" data-kind="emp" data-idx="${idx}" value="${escapeHtml(r.lastName)}" placeholder="Nachname">
          </div>
        </td>
      `);
      for (let m = 0; m < 12; m++) {
        tds.push(`
          <td class="month-col">
            <input type="number" step="0.01" min="0" max="1"
              class="sp-vk"
              data-kind="emp" data-idx="${idx}" data-month="${m}"
              value="${String(clamp2(r.values[m] || 0))}">
          </td>
        `);
      }
      const rowAvg = (r.values || []).reduce((a, b) => a + Number(b || 0), 0) / 12;
      tds.push(`<td data-row-sum>${fmt(rowAvg)}</td>`);
      tds.push(`<td class="qual-col">${qualSelectHTML(r.qual, idx, "emp")}</td>`);
      tds.push(`
              tds.push(`
        <td class="act-col">
          <div class="action-icons">
            <button class="action-icons-button action-hide" data-action="hide" data-kind="emp" data-idx="${idx}" title="Zeile ausblenden">&#128065;</button>
            <button class="action-icons-button action-trash" data-action="delete" data-kind="emp" data-idx="${idx}" title="Zeile loeschen">&#128465;</button>
            <button class="action-icons-button action-copy" data-action="copy" data-kind="emp" data-idx="${idx}" type="button" title="Werte fortfuehren">&#10230;</button>
          </div>
        </td>
      `)
      `);
      tr.innerHTML = tds.join("");
      tbody.appendChild(tr);
      const sel = tr.querySelector("select.sp-qual");
      if (sel) sel.value = r.qual || "";
    });
  }

  function renderExtrasTable() {
    const plan = ensurePlan();
    const table = els.extrasTable;
    if (!table) return;
    const tbody = table.querySelector("tbody") || table.appendChild(document.createElement("tbody"));
    tbody.innerHTML = "";

    plan.extras.forEach((x, idx) => {
      const tr = document.createElement("tr");
      tr.dataset.kind = "extra";
      tr.dataset.idx = String(idx);
      if (x.hiddenRow) tr.style.display = "none";
      const tds = [];
      tds.push(`
        <td class="ctrl-col">
          <input type="checkbox" class="sp-include" data-kind="extra" data-idx="${idx}" ${x.include ? "checked" : ""}>
        </td>
      `);
      tds.push(`
        <td class="pnr-col">
          <input class="sp-pnr" data-kind="extra" data-idx="${idx}" value="${escapeHtml(x.personalNumber)}" placeholder="ID/Key">
        </td>
      `);
      tds.push(`
        <td class="name-col">
          <input class="sp-category" data-kind="extra" data-idx="${idx}" value="${escapeHtml(x.category)}" placeholder="Kategorie">
        </td>
      `);
      tds.push(`<td class="qual-col">${qualSelectHTML(x.qual, idx, "extra")}</td>`);
      for (let m = 0; m < 12; m++) {
        tds.push(`
          <td class="month-col">
            <input type="number" step="0.01" min="0" max="2"
              class="sp-vk"
              data-kind="extra" data-idx="${idx}" data-month="${m}"
              value="${String(clamp2(x.values[m] || 0))}">
          </td>
        `);
      }
      tds.push(`
        <td class="act-col">
          <button class="sp-hide" data-kind="extra" data-idx="${idx}" title="Zeile ausblenden">Ausblenden</button>
          <button class="sp-del" data-kind="extra" data-idx="${idx}" title="Zeile loeschen">Loeschen</button>
        </td>
      `);
      tr.innerHTML = tds.join("");
      tbody.appendChild(tr);
      const sel = tr.querySelector("select.sp-qual");
      if (sel) sel.value = x.qual || "";
    });
  }

  function recalcTotals() {
    const plan = ensurePlan();
    const monthSum = Array(12).fill(0);
    const addRow = (row) => {
      if (!row.include || row.hiddenRow) return;
      for (let m = 0; m < 12; m++) monthSum[m] += Number(row.values[m] || 0);
    };
    plan.employees.forEach(addRow);
    plan.extras.forEach(addRow);
    const table = els.planTable;
    if (table) {
      for (let m = 0; m < 12; m++) {
        const cell = table.querySelector(`[data-sum-month="${m}"]`);
        if (cell) cell.textContent = fmt(monthSum[m]);
      }
      const totalYearCell = table.querySelector("[data-total-year]");
      if (totalYearCell) totalYearCell.textContent = fmt(monthSum.reduce((a, b) => a + b, 0) / 12);
    }
    const sumYear = monthSum.reduce((a, b) => a + b, 0);
    const avg = sumYear / 12;
    const peak = Math.max(...monthSum);
    if (els.sumYear) els.sumYear.textContent = fmt(sumYear);
    if (els.avgMonth) els.avgMonth.textContent = fmt(avg);
    if (els.peakMonth) els.peakMonth.textContent = fmt(peak);
  }

  function renderAll() {
    renderPlanTable();
    renderExtrasTable();
    recalcTotals();
  }

  async function loadLookups() {
    try {
      const units = await API.getOrgUnits();
      state.orgUnits = Array.isArray(units) && units.length ? units : FALLBACK_ORG_UNITS;
      const quals = await API.getQualifikationen();
      state.qualOptions = (Array.isArray(quals) ? quals.map(q => q.bezeichnung) : []).filter(Boolean);
      if (!state.qualOptions.length) state.qualOptions = FALLBACK_QUAL_OPTIONS;
    } catch (error) {
      console.warn("Lookups fehlgeschlagen, verwende Fallback", error);
      state.orgUnits = FALLBACK_ORG_UNITS;
      state.qualOptions = FALLBACK_QUAL_OPTIONS;
    }
  }

  function populateOrgSelect() {
    if (!els.deptSelect) return;
    els.deptSelect.innerHTML = state.orgUnits.map(u => `<option value="${escapeHtml(u.code)}">${escapeHtml(u.name)}</option>`).join("");
    if (!state.dept && state.orgUnits[0]) state.dept = state.orgUnits[0].code;
    els.deptSelect.value = state.dept;
  }

  function populateYear() {
    if (!els.yearInput) return;
    els.yearInput.value = String(state.year);
  }

  async function loadFromDb() {
    ensurePlan();
    setStatus("Lade ...");
    try {
      const remote = await API.loadPlan(state.dept, state.year);
      const k = key();
      state.data[k] = {
        employees: Array.isArray(remote.employees) ? remote.employees : [],
        extras: Array.isArray(remote.extras) ? remote.extras : [],
      };
      ensurePlan();
      saveStorage();
      renderAll();
      setStatus("Geladen");
    } catch (e) {
      console.warn(e);
      renderAll();
      setStatus("DB-Laden fehlgeschlagen - lokale Daten genutzt", true);
    }
  }

  async function saveToDb() {
    const plan = ensurePlan();
    setStatus("Speichere ...");
    try {
      const payload = {
        orgCode: state.dept,
        year: Number(state.year),
        employees: plan.employees.map(r => ({
          personalNumber: String(r.personalNumber || "").trim(),
          name: String(r.name || "").trim(),
          qual: String(r.qual || ""),
          include: !!r.include,
          hiddenRow: !!r.hiddenRow,
          values: (r.values || []).map(v => clamp2(v)),
        })),
        extras: plan.extras.map(x => ({
          personalNumber: String(x.personalNumber || "").trim(),
          category: String(x.category || "Zusatz").trim(),
          qual: String(x.qual || ""),
          include: !!x.include,
          hiddenRow: !!x.hiddenRow,
          values: (x.values || []).map(v => clamp2(v)),
        })),
      };
      await API.savePlan(payload);
      saveStorage();
      const ts = new Date().toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" });
      setStatus(`Gespeichert (${ts})`);
    } catch (e) {
      console.error(e);
      setStatus(`Speichern fehlgeschlagen: ${e?.message || e}`, true);
    }
  }

  function setLastFocus(kind, idx, month) {
    lastFocus = { kind, idx, month };
  }

  function wireEvents() {
    if (els.deptSelect) {
      els.deptSelect.addEventListener("change", async () => {
        state.dept = els.deptSelect.value;
        saveStorage();
        await loadFromDb();
      });
    }
    if (els.yearInput) {
      els.yearInput.addEventListener("change", async () => {
        const y = Number(els.yearInput.value || state.year);
        state.year = Number.isFinite(y) && y > 1990 ? y : state.year;
        els.yearInput.value = String(state.year);
        saveStorage();
        await loadFromDb();
      });
    }
    if (els.btnSaveDb) els.btnSaveDb.addEventListener("click", saveToDb);
    if (els.btnAddRow) {
      els.btnAddRow.addEventListener("click", () => {
        const plan = ensurePlan();
        plan.employees.push({
          personalNumber: "",
          name: "Neu",
          qual: "",
          include: true,
          hiddenRow: false,
          values: Array(12).fill(0),
        });
        saveStorage();
        renderAll();
      });
    }
    if (els.btnAddExtra) {
      els.btnAddExtra.addEventListener("click", () => {
        const plan = ensurePlan();
        plan.extras.push({
          personalNumber: "",
          category: "Zusatz",
          qual: "",
          include: true,
          hiddenRow: false,
          values: Array(12).fill(0),
        });
        saveStorage();
        renderAll();
      });
    }
    const onTableInput = (ev) => {
      const t = ev.target;
      if (!t) return;
      const kind = t.dataset.kind;
      const idx = Number(t.dataset.idx);
      if (!Number.isFinite(idx)) return;
      const plan = ensurePlan();
      const row = kind === "extra" ? plan.extras[idx] : plan.employees[idx];
      if (!row) return;
      if (t.classList.contains("sp-pnr")) {
        row.personalNumber = String(t.value || "");
      } else if (t.classList.contains("sp-name-first")) {
        row.firstName = String(t.value || "");
        syncName(row);
      } else if (t.classList.contains("sp-name-last")) {
        row.lastName = String(t.value || "");
        syncName(row);
      } else if (t.classList.contains("sp-category")) {
        row.category = String(t.value || "");
      } else if (t.classList.contains("sp-vk")) {
        const m = Number(t.dataset.month);
        const v = clamp2(t.value);
        if (m >= 0 && m < 12) row.values[m] = v;
        setLastFocus(kind, idx, m);
      } else if (t.classList.contains("sp-qual")) {
        const opts = Array.from(t.selectedOptions || []);
        const values = opts.map(o => String(o.value || "").trim()).filter(Boolean);
        row.qual = values.join(", ");
      }
      saveStorage();
      recalcTotals();
      setStatus("Ungespeichert");
    };
        const onTableClick = (ev) => {
      const t = ev.target;
      if (!t || !(t instanceof HTMLElement)) return;
      const kind = t.dataset.kind;
      const idx = Number(t.dataset.idx);
      if (!Number.isFinite(idx)) return;
      const plan = ensurePlan();
      const list = kind === 'extra' ? plan.extras : plan.employees;
      const action = t.dataset.action;
      if (action) {
        const row = list[idx];
        if (!row) return;
        if (action === 'copy') {
          const startMonth = lastFocus && lastFocus.kind === kind && lastFocus.idx === idx && Number.isFinite(lastFocus.month)
            ? lastFocus.month
            : 0;
          const sourceVal = row.values[startMonth] || 0;
          for (let m = startMonth; m < 12; m++) {
            row.values[m] = sourceVal;
          }
          saveStorage();
          renderAll();
          setStatus('Zeile fortgeführt');
          return;
        }
        if (action === 'hide') {
          row.hiddenRow = !row.hiddenRow;
          row.include = !row.hiddenRow;
          saveStorage();
          renderAll();
          setStatus('Zeile ein-/ausgeblendet');
          return;
        }
        if (action === 'delete') {
          list.splice(idx, 1);
          saveStorage();
          renderAll();
          setStatus('Zeile gelöscht');
          return;
        }
      }
    };
    if (els.planTable) {
      els.planTable.addEventListener("input", onTableInput);
      els.planTable.addEventListener("change", onTableInput);
      els.planTable.addEventListener("click", onTableClick);
    }
    if (els.extrasTable) {
      els.extrasTable.addEventListener("input", onTableInput);
      els.extrasTable.addEventListener("change", onTableInput);
      els.extrasTable.addEventListener("click", onTableClick);
    }
  }

  async function boot() {
    loadStorage();
    if (els.yearInput && els.yearInput.value) {
      const y = Number(els.yearInput.value);
      if (Number.isFinite(y) && y > 1990) state.year = y;
    }
    try {
      await loadLookups();
      populateOrgSelect();
      populateYear();
      state.dept = els.deptSelect?.value || state.dept;
      wireEvents();
      await loadFromDb();
    } catch (e) {
      console.error(e);
      wireEvents();
      ensurePlan();
      renderAll();
      setStatus("Initialisierung fehlgeschlagen (Lookups/API).", true);
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot);
  } else {
    boot();
  }
})();

  </script>
  </template>

  <script>
    const __pageContent = document.getElementById("page-content")?.innerHTML || "";
    const __pageStyle = document.getElementById("page-style")?.textContent || "";
    const __pageTitle = document.title || "";

    fetch("./layout.html")
      .then((r) => r.text())
      .then((html) => {
        document.open();
        document.write(html);
        document.close();

        window.addEventListener("DOMContentLoaded", () => {
          if (__pageStyle) {
            const style = document.createElement("style");
            style.setAttribute("data-page-style", "true");
            style.textContent = __pageStyle;
            document.head.appendChild(style);
          }

          if (__pageTitle) {
            document.title = __pageTitle;
            const headerTitle = document.querySelector(".topbar-left h1");
            if (headerTitle) {
              headerTitle.textContent = __pageTitle;
            }
          }

          const slot = document.getElementById("app-main") || document.querySelector("main");
          if (slot) {
            slot.innerHTML = __pageContent;

            const scripts = Array.from(slot.querySelectorAll("script"));
            const runScripts = (index) => {
              if (index >= scripts.length) return;
              const oldScript = scripts[index];
              const script = document.createElement("script");
              Array.from(oldScript.attributes).forEach((attr) => {
                script.setAttribute(attr.name, attr.value);
              });
              script.async = false;
              if (oldScript.textContent) {
                script.textContent = oldScript.textContent;
              }
              const next = () => runScripts(index + 1);
              if (script.src) {
                script.onload = next;
                script.onerror = next;
              }
              oldScript.replaceWith(script);
              if (!script.src) {
                next();
              }
            };
            runScripts(0);
          }

          const current = (location.pathname.split("/").pop() || "").toLowerCase();
          document.querySelectorAll(".nav a[href]").forEach((a) => a.classList.remove("active"));
          document.querySelectorAll(".nav a[href]").forEach((a) => {
            const href = (a.getAttribute("href") || "").split("?")[0].split("#")[0].toLowerCase();
            if (href && href === current) {
              a.classList.add("active");
            }
          });
        });
      });
  </script>
</body>
</html>


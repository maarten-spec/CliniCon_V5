<link rel="stylesheet" href="shared/ui-base.css" />
<section class="card page-frame ppug-layout ui-scope" id="ppbv-tool">
  <div class="ppug-grid">
    <header class="ppug-card ppbv-hero">
      <div>
        <h2>PPBV Erwachsene &ndash; PPBV-Berechner</h2>
        <p class="section-lead">Tagschicht nach PPBV, Nachtdienst nach PPUG &ndash; komplett im Layout des PPUG-Rechners.</p>
        <p class="section-lead">Stand 12.06.2024 (Aenderungen 05.12.2024) &middot; VZAe-Bezugsgroesse &sect;2 Abs.7 (38,5 h/Woche) &middot; Tagschicht &sect;4 Abs.2 &middot; Nachtschicht &sect;4 Abs.3.</p>
      </div>
      <button id="btnFAQ" type="button" class="btn ghost">FAQ oeffnen</button>
    </header>

    <section class="ppug-card">
      <div class="section-head">
        <div>
          <h3>Tagschicht &ndash; PPBV Erwachsene (&sect;4 Abs.2 / &sect;12)</h3>
          <p class="muted">Grundwert + Patientengruppen + Fallwerte.</p>
        </div>
        <button id="btnResetTag" type="button" class="btn ghost">Zuruecksetzen</button>
      </div>
      <div class="row">
        <label class="field span-4">Vollstationaer gesamt
          <input id="vollGesamt" type="number" min="0" value="16" />
        </label>
        <label class="field span-4">davon Isolation
          <input id="isoAnzahl" type="number" min="0" value="0" />
        </label>
        <label class="field span-4">Teilstationaer (Anzahl)
          <input id="teilAnzahlDummy" type="number" min="0" value="0" />
        </label>
      </div>
      <div class="row">
        <label class="field span-4">Aufnahmen vollstationaer / einmalig (&sect;12 Abs.3)
          <input id="aufnahmenEinmalig" type="number" min="0" value="0" />
        </label>
        <label class="field span-4">Teilstationaer regelmaessig (&sect;12 Abs.4)
          <input id="tsRegelmaessig" type="number" min="0" value="0" />
        </label>
        <div class="field span-4 add-group">
          <label>Patientengruppe (&sect;9/&sect;12)</label>
          <button id="btnAddRow" type="button" class="btn primary">Patientengruppe hinzufuegen</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Patientengruppe</th>
              <th>Voll</th>
              <th>Teil</th>
              <th>Min./Pat.</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="groupRows"></tbody>
        </table>
      </div>
      <div class="kpi-grid">
        <div class="kpi-tile">
          <small>Pflegegrundwert</small>
          <strong><span id="grundwertMin">0</span> Min</strong>
        </div>
        <div class="kpi-tile">
          <small>Gruppen-Minuten</small>
          <strong><span id="gruppenMin">0</span> Min</strong>
        </div>
        <div class="kpi-tile">
          <small>Fallwerte</small>
          <strong><span id="fallwertMin">0</span> Min</strong>
        </div>
        <div class="kpi-tile highlight">
          <small>Gesamtminuten Tag</small>
          <strong><span id="tagMinGesamt">0</span> Min</strong>
        </div>
        <div class="kpi-tile">
          <small>Pflege-Stunden Tag</small>
          <strong><span id="tagHoursOut">0.00</span> h</strong>
        </div>
        <div class="kpi-tile">
          <small>VZAe Tag (&Oslash;)</small>
          <strong><span id="tagFTE">0.00</span></strong>
        </div>
      </div>
    </section>

    <section class="ppug-card">
      <div class="section-head">
        <div>
          <h3>Nachtschicht &ndash; Empfehlung nach PPUG (&sect;4 Abs.3)</h3>
          <p class="muted">Dropdown wie beim PPUG-Rechner: Quotient + Hilfskraft-Anteil werden automatisch beruecksichtigt.</p>
        </div>
        <button id="btnResetNacht" type="button" class="btn ghost">Zuruecksetzen</button>
      </div>
      <div class="row">
        <label class="field span-6">Bereich (PPUG-Verordnung)
          <select id="nachtBereich"></select>
        </label>
        <label class="field span-3">Nachtstunden (&sect;2 Abs.11)
          <input id="nachtHours" type="number" min="1" value="8" />
        </label>
        <label class="field span-3 checkbox">
          <input id="isTagesklinik" type="checkbox" /> Tagesklinik / kein Nachtdienst
        </label>
      </div>
      <div class="row">
        <label class="field span-4">Berechnete Betten
          <output id="nachtBettenInfo">0</output>
        </label>
        <div class="field span-8">
          <label>PPUG-Nachtratio</label>
          <p class="muted">Verhaeltnis: <span id="nachtRatioInfo">-</span> &middot; Hilfskraefte max.: <span id="nachtCapInfo">-</span></p>
        </div>
      </div>
      <div class="kpi-grid">
        <div class="kpi-tile">
          <small>Erforderliche Pflegekraefte (Koepfe)</small>
          <strong><span id="nachtKopf">0.00</span></strong>
        </div>
        <div class="kpi-tile">
          <small>Pflege-Stunden Nacht</small>
          <strong><span id="nachtHoursOut">0.00</span> h</strong>
        </div>
        <div class="kpi-tile">
          <small>VZAe Nacht (&Oslash;)</small>
          <strong><span id="nachtFTE">0.00</span></strong>
        </div>
        <div class="kpi-tile">
          <small>Fachpersonen (Koepfe)</small>
          <strong><span id="nachtFachSplit">0.00</span></strong>
        </div>
        <div class="kpi-tile">
          <small>Hilfskraefte (Koepfe)</small>
          <strong><span id="nachtHilfSplit">0.00</span></strong>
        </div>
      </div>
    </section>

    <section class="ppug-card">
      <div class="section-head">
        <h3>Ergebnis & Kennzahlen</h3>
      </div>
      <div class="kpi-grid summary">
        <div class="kpi-tile">
          <small>Tagschicht (PPBV)</small>
          <strong><span id="resTagFTE">0.00</span> VZAe</strong>
        </div>
        <div class="kpi-tile">
          <small>Nachtschicht (PPUG)</small>
          <strong><span id="resNachtFTE">0.00</span> VZAe</strong>
        </div>
        <div class="kpi-tile">
          <small>Gesamtbedarf</small>
          <strong><span id="resGesamt">0.00</span> VZAe</strong>
        </div>
        <div class="kpi-tile">
          <small>Max. Hilfskraefte (20 %)</small>
          <strong><span id="resHilfMax">0.00</span> VZAe</strong>
        </div>
        <div class="kpi-tile">
          <small>Max. Auszubildende (10 %)</small>
          <strong><span id="resAzubiMax">0.00</span> VZAe</strong>
        </div>
        <div class="kpi-tile ampel-card" id="ampelBox" role="status" aria-live="polite">
          <div class="ampel-status">
            <span class="ampel-dot status-dot" aria-hidden="true"></span>
            <div>
              <small id="ampelLabel">Taganteil</small>
              <strong class="ampel-value" id="ampelValue">&ndash;</strong>
            </div>
          </div>
          <p class="muted" id="ampelNote">Bewertet den Anteil der Tagschicht am Gesamtbedarf.</p>
        </div>
      </div>
    </section>
  </div>
</section>

<div class="ppbv-modal" id="faqModal" aria-hidden="true">
  <div class="modal-backdrop" data-close="faq"></div>
  <div class="modal-panel">
    <header>
      <h3>FAQ &ndash; PPBV / PPUG</h3>
    </header>
    <div class="modal-body">
      <div class="faq-grid">
        <article class="faq-card">
          <strong>Wie wird der Pflegegrundwert ermittelt?</strong>
          <p>Vollstationaere Patientinnen und Patienten fliessen mit 33 Minuten, Isolationen mit 123 Minuten ein. Teil- und besonderen Gruppen werden zusaetzlich ueber die Tabelle gewichtet.</p>
        </article>
        <article class="faq-card">
          <strong>Warum PPUG fuer die Nachtschicht?</strong>
          <p>Die PPBV kennt keinen ausdruecklichen Nacht-Schluessel. Daher orientiert sich die Empfehlung am PPUG-Bereich: Bettenbasis aus der Tagschicht, Betreuungsschluessel gemaess Verordnung.</p>
        </article>
        <article class="faq-card">
          <strong>Wie komme ich zu VZAe?</strong>
          <p>Alle Minuten werden in Stunden umgerechnet und durch die Bezugsgroesse (38,5 Wochenstunden / 7 Kalendertage) geteilt. So ergibt sich ein durchschnittlicher Tagesbedarf an Vollzeitaequivalenten.</p>
        </article>
      </div>
    </div>
    <footer>
      <button type="button" class="btn ghost" id="btnFAQClose" data-close="faq">Schliessen</button>
    </footer>
  </div>
</div>

<style>
  #ppbv-tool {
    padding: 0;
    overflow: hidden;
  }
  #ppbv-tool .ppug-grid{
    gap: var(--space-4);
    padding: clamp(0.7rem, 2vw, 0.9rem);
  }
  #ppbv-tool .ppbv-hero {
    display: flex;
    justify-content: space-between;
    gap: var(--space-5);
    align-items: flex-start;
  }
  #ppbv-tool h2 {
    margin: 0 0 8px;
    
    color: #0f172a;
  }
  #ppbv-tool .section-lead {
    margin: 0;
    color: var(--muted,#64748b);
    
  }
  #ppbv-tool .section-head {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-4);
  }
  #ppbv-tool .checkbox {
    flex-direction: row;
    align-items: center;
    gap: var(--space-2);
  }
  #ppbv-tool .table-select,
  #ppbv-tool .table-input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border-radius: var(--radius-md);
    border: 1px solid var(--line,#e2e8f0);
    background: #fff;
  }
  #ppbv-tool .table-input {
    text-align: right;
  }
  #ppbv-tool .table-minutes {
    font-weight: 600;
    color: #475569;
  }
  #ppbv-tool .text-right {
    text-align: right;
  }
  #ppbv-tool .link-danger {
    border: none;
    background: none;
    color: #dc2626;
    font-weight: 600;
    cursor: pointer;
  }
  #ppbv-tool .link-danger:hover {
    text-decoration: underline;
  }
  #ppbv-tool .kpi-grid.summary {
    grid-template-columns: repeat(auto-fit, minmax(clamp(12rem, 24vw, 15rem), 1fr));
  }
  #ppbv-tool .kpi-tile strong {
    
    color: #0f172a;
  }
  #ppbv-tool .kpi-tile.highlight {
    background: #fef9c3;
    border-color: #fde68a;
  }
  #ppbv-tool .ampel-card {
    --status-color:#94a3b8;
    background: #f8fafc;
    border-color: #e2e8f0;
  }
  #ppbv-tool .ampel-status {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }
  #ppbv-tool .ampel-dot {
    background:var(--status-color);
  }
  #ppbv-tool .ampel-card.status-success { --status-color: var(--success); }
  #ppbv-tool .ampel-card.status-warn { --status-color: var(--warning); }
  #ppbv-tool .ampel-card.status-danger { --status-color: var(--danger); }
  #ppbv-tool .ampel-value {
    
  }
  @media (max-width: 960px) {
    #ppbv-tool .ppbv-hero {
      flex-direction: column;
    }
  }
  .ppbv-modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: flex-start;
    justify-content: center;
    padding: var(--space-8) var(--space-4);
    z-index: 50;
  }
  .ppbv-modal[aria-hidden="false"] {
    display: flex;
  }
  .ppbv-modal .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, .5);
  }
  .ppbv-modal .modal-panel {
    position: relative;
    z-index: 1;
    max-width: 60rem;
    width: 100%;
    border-radius: var(--radius-lg);
    background: #fff;
    box-shadow: 0 25px 40px rgba(15, 23, 42, .25);
    overflow: hidden;
  }
  .ppbv-modal header,
  .ppbv-modal footer {
    padding: var(--space-5) var(--space-6);
    border-bottom: 1px solid #e2e8f0;
  }
  .ppbv-modal footer {
    border-bottom: none;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: flex-end;
  }
  .ppbv-modal .modal-body {
    padding: 24px;
  }
  .ppbv-modal .faq-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(clamp(12rem, 24vw, 15rem), 1fr));
    gap: 16px;
  }
  .ppbv-modal .faq-card {
    border: 1px solid #e2e8f0;
    border-radius: 14px;
    padding: 16px;
    background: #f8fafc;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
</style>

<script>
  (() => {
    const WEEK_HOURS = 38.5;
    const DAILY_FTE_DIVISOR = WEEK_HOURS / 7;
    const PFLEGEGRUNDWERT = 33;
    const PFLEGEGRUNDWERT_ISO = 123;
    const FALLWERT = 75;

    const GROUP_MINUTES = {
      "A1/S1": 59,  "A1/S2": 76,  "A1/S3": 112, "A1/S4": 151,
      "A2/S1": 114, "A2/S2": 131, "A2/S3": 167, "A2/S4": 206,
      "A3/S1": 203, "A3/S2": 220, "A3/S3": 256, "A3/S4": 295,
      "A4/S1": 335, "A4/S2": 352, "A4/S3": 388, "A4/S4": 427
    };

    const PPUG_RULES = [
      { key: "intensiv", name: "Intensivmedizin", ratioDay: 2, ratioNight: 3, capDay: 5, capNight: 5 },
      { key: "geriatrie", name: "Geriatrie", ratioDay: 10, ratioNight: 20, capDay: 15, capNight: 20 },
      { key: "chir_ortho", name: "Allgemeine Chirurgie / Unfallchirurgie / Orthopaedie", ratioDay: 10, ratioNight: 20, capDay: 10, capNight: 10 },
      { key: "innere_kardio", name: "Innere Medizin / Kardiologie", ratioDay: 10, ratioNight: 22, capDay: 10, capNight: 10 },
      { key: "herzchir", name: "Herzchirurgie", ratioDay: 7, ratioNight: 15, capDay: 5, capNight: 0 },
      { key: "neuro", name: "Neurologie", ratioDay: 10, ratioNight: 20, capDay: 8, capNight: 8 },
      { key: "stroke", name: "Neurologische Schlaganfalleinheit", ratioDay: 3, ratioNight: 5, capDay: 0, capNight: 0 },
      { key: "fruehrehab", name: "Neurologische Fruehrehabilitation", ratioDay: 5, ratioNight: 12, capDay: 10, capNight: 10 },
      { key: "paed_allg", name: "Allgemeine Paediatrie", ratioDay: 6, ratioNight: 10, capDay: 5, capNight: 5 },
      { key: "paed_spez", name: "Spezielle Paediatrie", ratioDay: 6, ratioNight: 14, capDay: 5, capNight: 5 },
      { key: "neo", name: "Neonatologische Paediatrie", ratioDay: 3.5, ratioNight: 5, capDay: 5, capNight: 5 },
      { key: "gyn", name: "Gynaekologie &amp; Geburtshilfe", ratioDay: 7.5, ratioNight: 15, capDay: 5, capNight: 0 },
      { key: "hno_uro", name: "HNO &amp; Urologie", ratioDay: 10, ratioNight: 22, capDay: 10, capNight: 5 },
      { key: "rheuma", name: "Rheumatologie", ratioDay: 13, ratioNight: 30, capDay: 10, capNight: 5 },
      { key: "neurochir", name: "Neurochirurgie", ratioDay: 9, ratioNight: 18, capDay: 10, capNight: 5 }
    ];

    const $ = (id) => document.getElementById(id);
    const groupRowsEl = $("groupRows");
    const nightSelect = $("nachtBereich");

    function formatFixed(value) {
      return Number.isFinite(value) ? value.toFixed(2) : "0.00";
    }

    function populateNightAreas() {
      if (!nightSelect) return;
      nightSelect.innerHTML = "";
      PPUG_RULES.forEach((rule) => {
        const opt = document.createElement("option");
        opt.value = rule.key;
        opt.textContent = rule.name;
        nightSelect.appendChild(opt);
      });
      nightSelect.value = "chir_ortho";
    }

    function makeRow(group = "A1/S1", voll = 0, teil = 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <select class="table-select">
            ${Object.keys(GROUP_MINUTES).map((key) => `<option value="${key}" ${key === group ? "selected" : ""}>${key}</option>`).join("")}
          </select>
        </td>
        <td><input type="number" min="0" value="${voll}" class="table-input" /></td>
        <td><input type="number" min="0" value="${teil}" class="table-input" /></td>
        <td class="table-minutes">${GROUP_MINUTES[group]}</td>
        <td class="text-right"><button class="link-danger" type="button">Entfernen</button></td>
      `;
      const select = tr.querySelector("select");
      const inputs = tr.querySelectorAll("input");
      const minutesCell = tr.querySelector(".table-minutes");
      const btnRemove = tr.querySelector("button");
      select.addEventListener("change", () => {
        minutesCell.textContent = GROUP_MINUTES[select.value] || 0;
        calcAll();
      });
      inputs.forEach((input) => input.addEventListener("input", calcAll));
      btnRemove.addEventListener("click", () => {
        tr.remove();
        calcAll();
      });
      return tr;
    }

    function seedGroupRows() {
      if (!groupRowsEl) return;
      groupRowsEl.innerHTML = "";
      groupRowsEl.appendChild(makeRow("A2/S2", 6, 0));
      groupRowsEl.appendChild(makeRow("A3/S1", 4, 0));
    }

    function parseNumber(value) {
      if (value === undefined || value === null) return 0;
      const normalized = String(value).replace(",", ".");
      const num = parseFloat(normalized);
      return Number.isFinite(num) ? num : 0;
    }

    function getNumber(id) {
      const el = $(id);
      if (!el) return 0;
      return parseNumber(el.value);
    }

    function sumGroupMinutes() {
      let total = 0;
      if (!groupRowsEl) return total;
      groupRowsEl.querySelectorAll("tr").forEach((row) => {
        const select = row.querySelector("select");
        const inputs = row.querySelectorAll("input");
        const voll = parseFloat(inputs[0]?.value || "0") || 0;
        const teil = parseFloat(inputs[1]?.value || "0") || 0;
        const minutes = GROUP_MINUTES[select?.value] || 0;
        total += minutes * voll;
        total += 0.5 * minutes * teil;
      });
      return total;
    }

    function calcTag() {
      const voll = Math.max(0, getNumber("vollGesamt"));
      const teil = Math.max(0, getNumber("teilAnzahlDummy"));
      const iso = Math.min(Math.max(0, getNumber("isoAnzahl")), voll);
      const grundwert = (PFLEGEGRUNDWERT * (voll - iso)) +
        (PFLEGEGRUNDWERT_ISO * iso) +
        (0.5 * PFLEGEGRUNDWERT * teil);
      const gruppen = sumGroupMinutes();
      const fallwerte = FALLWERT * (getNumber("aufnahmenEinmalig") + getNumber("tsRegelmaessig"));
      const minuten = grundwert + gruppen + fallwerte;
      const stunden = minuten / 60;
      const tagFTE = stunden / DAILY_FTE_DIVISOR;
      $("grundwertMin").textContent = Math.round(grundwert);
      $("gruppenMin").textContent = Math.round(gruppen);
      $("fallwertMin").textContent = Math.round(fallwerte);
      $("tagMinGesamt").textContent = Math.round(minuten);
      $("tagHoursOut").textContent = stunden.toFixed(2);
      $("tagFTE").textContent = tagFTE.toFixed(2);
      return { tagFTE };
    }

    function getNightRule() {
      const value = nightSelect?.value;
      return PPUG_RULES.find((rule) => rule.key === value) || PPUG_RULES[0];
    }

    function splitStaff(totalHeads, capPct) {
      const maxHilf = totalHeads * (capPct / 100);
      let hilf = Math.min(maxHilf, totalHeads);
      let fach = Math.max(0, totalHeads - hilf);
      if (totalHeads >= 1 && fach < 1) {
        fach = 1;
        hilf = Math.max(0, totalHeads - fach);
      }
      return { fach, hilf };
    }

    function calcNight() {
      const rule = getNightRule();
      const betten = Math.max(0, getNumber("vollGesamt"));
      const hours = Math.max(0, getNumber("nachtHours") || 0);
      const isTagesklinik = $("isTagesklinik")?.checked;
      $("nachtBettenInfo").textContent = betten.toString();
      $("nachtRatioInfo").textContent = rule ? `1 : ${rule.ratioNight}` : "-";
      $("nachtCapInfo").textContent = rule ? `${rule.capNight} %` : "-";

      if (isTagesklinik || betten === 0 || !rule) {
        $("nachtKopf").textContent = "0.00";
        $("nachtHoursOut").textContent = "0.00";
        $("nachtFTE").textContent = "0.00";
        $("nachtFachSplit").textContent = "0.00";
        $("nachtHilfSplit").textContent = "0.00";
        return { nachtFTE: 0 };
      }

      const koepfe = betten / rule.ratioNight;
      const stunden = koepfe * hours;
      const teile = splitStaff(koepfe, rule.capNight);
      const nachtFTE = stunden / DAILY_FTE_DIVISOR;
      $("nachtKopf").textContent = formatFixed(koepfe);
      $("nachtHoursOut").textContent = formatFixed(stunden);
      $("nachtFTE").textContent = formatFixed(nachtFTE);
      $("nachtFachSplit").textContent = formatFixed(teile.fach);
      $("nachtHilfSplit").textContent = formatFixed(teile.hilf);
      return { nachtFTE };
    }

    function updateAmpel(tagFTE, totalFTE) {
      const box = $("ampelBox");
      const share = totalFTE > 0 ? tagFTE / totalFTE : 0;
      let state = "";
      let title = "Kein Bedarf";
      let note = "Bitte Eingaben pruefen.";
      if (totalFTE > 0) {
        if (share >= 0.65) {
          state = "success";
          title = "Tagesfokus";
          note = "Mindestens 65 % des Gesamtbedarfs entfallen auf die Tagschicht.";
        } else if (share >= 0.5) {
          state = "warn";
          title = "Ausgewogen";
          note = "Tag- und Nachtschicht sind nahezu ausgeglichen.";
        } else {
          state = "danger";
          title = "Nachtlastig";
          note = "Taganteil liegt unter 50 % des Gesamtbedarfs.";
        }
      }
      if (box) {
        const statusClass = state === "success"
          ? "status-success"
          : state === "warn"
            ? "status-warn"
            : "status-danger";
        box.className = `kpi-tile ampel-card ${statusClass}`.trim();
      }
      $("ampelLabel").textContent = totalFTE > 0 ? `Taganteil ${ (share * 100).toFixed(1) } %` : "Taganteil";
      $("ampelValue").textContent = title;
      $("ampelNote").textContent = note;
    }

    function updateSummary(tagFTE, nachtFTE) {
      const total = tagFTE + nachtFTE;
      $("resTagFTE").textContent = formatFixed(tagFTE);
      $("resNachtFTE").textContent = formatFixed(nachtFTE);
      $("resGesamt").textContent = formatFixed(total);
      $("resHilfMax").textContent = formatFixed(total * 0.2);
      $("resAzubiMax").textContent = formatFixed(total * 0.1);
      updateAmpel(tagFTE, total);
    }

    function calcAll() {
      const { tagFTE } = calcTag();
      const { nachtFTE } = calcNight();
      updateSummary(tagFTE, nachtFTE);
    }

    const btnAddRow = $("btnAddRow");
    btnAddRow?.addEventListener("click", () => {
      groupRowsEl?.appendChild(makeRow());
      calcAll();
    });

    $("btnResetTag")?.addEventListener("click", () => {
      const defaults = {
        vollGesamt: 16,
        isoAnzahl: 0,
        teilAnzahlDummy: 0,
        aufnahmenEinmalig: 0,
        tsRegelmaessig: 0
      };
      Object.entries(defaults).forEach(([id, value]) => {
        const el = $(id);
        if (el) el.value = value;
      });
      seedGroupRows();
      calcAll();
    });

    $("btnResetNacht")?.addEventListener("click", () => {
      if (nightSelect) nightSelect.value = "chir_ortho";
      const nightHours = $("nachtHours");
      if (nightHours) nightHours.value = 8;
      const tk = $("isTagesklinik");
      if (tk) tk.checked = false;
      calcAll();
    });

    ["vollGesamt", "isoAnzahl", "teilAnzahlDummy", "aufnahmenEinmalig", "tsRegelmaessig", "nachtHours"].forEach((id) => {
      $(id)?.addEventListener("input", calcAll);
    });
    nightSelect?.addEventListener("change", calcAll);
    $("isTagesklinik")?.addEventListener("change", calcAll);

    const faqModal = $("faqModal");
    const closeFAQ = () => faqModal?.setAttribute("aria-hidden", "true");
    const openFAQ = () => faqModal?.setAttribute("aria-hidden", "false");
    $("btnFAQ")?.addEventListener("click", openFAQ);
    $("btnFAQClose")?.addEventListener("click", closeFAQ);
    faqModal?.addEventListener("click", (event) => {
      if (event.target.dataset.close === "faq") closeFAQ();
    });

    populateNightAreas();
    seedGroupRows();
    calcAll();
  })();
</script>
